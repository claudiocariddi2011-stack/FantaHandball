<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fanta Handball Pro - Live Auction</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,700;1,900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-deep: #020617;
            --card-bg: #1e293b;
            --accent-orange: #f97316;
            --accent-dark: #9a3412;
            --text-white: #f8fafc;
            --glass: rgba(255, 255, 255, 0.05);
            --field-blue: #3b82f6;
            --area-orange: #f97316;
        }
        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            color: var(--text-white);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; inset: 0;
            background: rgba(2, 6, 23, 0.98);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; backdrop-filter: blur(20px);
        }
        .login-box {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            padding: 40px; border-radius: 24px; text-align: center;
            width: 90%; max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-box h1 { font-family: 'Exo 2'; font-weight: 900; font-style: italic; font-size: 2.2rem; color: var(--accent-orange); margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: none; background: #020617; color: white; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 15px; background: var(--accent-orange); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer; }

        /* --- DASHBOARD --- */
        #site-content { display: none; max-width: 1100px; margin: 0 auto; padding: 40px 20px; }
        header h1 { font-family: 'Exo 2'; font-style: italic; text-align: center; font-size: 3rem; margin-bottom: 40px; }
        
        .dashboard-grid { display: grid; grid-template-columns: 240px 1fr; gap: 30px; }
        .sidebar { background: var(--glass); border-radius: 15px; overflow: hidden; height: fit-content; border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--accent-orange); color: white; }

        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s; }

        /* --- MERCATO & CARDS --- */
        .league-card, .player-card {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .bid-info { color: var(--accent-orange); font-weight: bold; font-size: 0.9rem; margin-top: 4px; }
        .bid-controls { display: flex; gap: 10px; }
        .bid-input { width: 60px; background: #000; color: #fff; border: 1px solid var(--accent-orange); border-radius: 5px; text-align: center; }

        /* --- CAMPO --- */
        .handball-field {
            width: 100%; max-width: 450px; height: 320px; background: var(--field-blue);
            margin: 20px auto; border: 3px solid #fff; border-radius: 10px; position: relative;
            background-image: radial-gradient(circle at 50% 100%, var(--area-orange) 90px, transparent 91px);
        }
        .player-slot {
            position: absolute; width: 50px; height: 50px; background: rgba(0,0,0,0.6);
            border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 0.7rem; font-weight: bold; cursor: pointer;
        }
        .player-slot.occupied { background: var(--accent-orange); border-color: #fff; }

        /* Posizioni Slot */
        .pos-po { bottom: 10px; left: 44%; } .pos-as { top: 130px; left: 5%; }
        .pos-ts { top: 60px; left: 20%; }  .pos-ce { top: 30px; left: 44%; }
        .pos-td { top: 60px; right: 20%; } .pos-ad { top: 130px; right: 5%; }
        .pos-pi { top: 100px; left: 44%; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1>FANTA HANDBALL</h1>
            <input type="text" id="username" placeholder="Tuo Nome (es. Luca)">
            <input type="text" id="league-input" placeholder="Nome Lega (es. Serie A)">
            <button onclick="enterSite()">ENTRA NELLA LEGA</button>
        </div>
    </div>

    <div id="site-content">
        <header><h1>FANTA HANDBALL</h1></header>
        
        <div class="dashboard-grid">
            <nav class="sidebar">
                <div class="nav-item active" onclick="showSection('home', this)">HOME</div>
                <div class="nav-item" onclick="showSection('leghe', this)">LISTA LEGHE</div>
                <div class="nav-item" onclick="showSection('mercato', this)">MERCATO LIVE</div>
                <div class="nav-item" onclick="showSection('rosa', this)">MIA ROSA</div>
            </nav>

            <main>
                <section id="home" class="content-section active">
                    <h2 id="user-greeting">Ciao!</h2>
                    <p>Lega Attuale: <b id="league-name-display" style="color:var(--accent-orange)">-</b></p>
                    <div style="background:var(--glass); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.1)">
                        <p>I tuoi Crediti: <b id="budget-display" style="font-size:1.5rem">100</b></p>
                    </div>
                </section>

                <section id="leghe" class="content-section">
                    <h2>LEGHE ATTIVE</h2>
                    <div id="league-list"></div>
                </section>

                <section id="mercato" class="content-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>ASTA LIVE</h2>
                        <div>
                            <button id="start-btn" onclick="toggleAuction(true)" style="background:#22c55e; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">AVVIA ASTA</button>
                            <button id="stop-btn" onclick="closeAuction()" style="display:none; background:#ef4444; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">CHIUDI ASTA</button>
                        </div>
                    </div>
                    <div id="market-players"></div>
                </section>

                <section id="rosa" class="content-section">
                    <h2>IL TUO TEAM</h2>
                    <div class="handball-field">
                        <div id="slot-PO" class="player-slot pos-po" onclick="removeFromField('PO')">PO</div>
                        <div id="slot-AS" class="player-slot pos-as" onclick="removeFromField('AS')">AS</div>
                        <div id="slot-TS" class="player-slot pos-ts" onclick="removeFromField('TS')">TS</div>
                        <div id="slot-CE" class="player-slot pos-ce" onclick="removeFromField('CE')">CE</div>
                        <div id="slot-TD" class="player-slot pos-td" onclick="removeFromField('TD')">TD</div>
                        <div id="slot-AD" class="player-slot pos-ad" onclick="removeFromField('AD')">AD</div>
                        <div id="slot-PI" class="player-slot pos-pi" onclick="removeFromField('PI')">PI</div>
                    </div>
                    <div id="my-rosa-list" style="margin-top:20px;"></div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTqPPwpfNElGluzwjv9nsy8EYBzJUXm2M",
            databaseURL: "https://fantahandaball-default-rtdb.europe-west1.firebasedatabase.app/", 
            projectId: "fantahandaball",
            storageBucket: "fantahandaball.firebasestorage.app",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- STATO APP ---
        let userName = "";
        let currentLeague = "";
        let budget = 100;
        let auctionActive = false;
        let currentBids = {};
        let myTeam = [];
        let fieldOccupancy = {};

        let players = [
            { id: 1, name: "Cristian Falsaperla", team: "New Handball", role: "TER" },
            { id: 2, name: "Claudio Cariddi", team: "Messina", role: "TER" },
            { id: 3, name: "Yuri Sigona", team: "Modica", role: "TER" },
            { id: 4, name: "AndrÃ¨ Pagano", team: "Th Mascalucia", role: "TER" },
            { id: 5, name: "Leonardo Livoli", team: "Albatro", role: "TER" },
            { id: 6, name: "Pasquale Caruso", team: "Avola", role: "TER" },
            { id: 7, name: "Francesco Rendo", team: "Modica", role: "TER" },
            { id: 8, name: "Leonardo Mineo", team: "TH", role: "TER" }
        ];

        // --- LOGICA DI ACCESSO E SINCRONIZZAZIONE ---
        function enterSite() {
            userName = document.getElementById('username').value.trim();
            currentLeague = document.getElementById('league-input').value.trim();
            
            if (!userName || !currentLeague) return alert("Inserisci Nome e Lega!");

            document.getElementById('login-overlay').style.display = "none";
            document.getElementById('site-content').style.display = "block";
            
            document.getElementById('user-greeting').innerText = "Bentornato, " + userName + "!";
            document.getElementById('league-name-display').innerText = currentLeague;

            // 1. Registra la lega su DB
            db.ref('leagues/' + currentLeague).update({ admin: userName, active: true });

            // 2. Ascolta la lista globale delle leghe (per altri telefoni)
            db.ref('leagues').on('value', (snapshot) => {
                const list = snapshot.val();
                const container = document.getElementById('league-list');
                container.innerHTML = "";
                for (let id in list) {
                    container.innerHTML += `
                        <div class="league-card">
                            <span><b>${id}</b> (Admin: ${list[id].admin})</span>
                            <button onclick="joinLeague('${id}')" style="padding:5px 10px; cursor:pointer">UNISCITI</button>
                        </div>`;
                }
            });

            listenToLeagueData();
        }

        function joinLeague(id) {
            currentLeague = id;
            document.getElementById('league-name-display').innerText = currentLeague;
            listenToLeagueData();
            showSection('home', document.querySelector('.nav-item'));
            alert("Sei entrato in: " + id);
        }

        function listenToLeagueData() {
            // Ascolta Cambiamenti Asta e Offerte in tempo reale
            db.ref('leagues/' + currentLeague).on('value', (snapshot) => {
                const data = snapshot.val() || {};
                auctionActive = data.auctionActive || false;
                currentBids = data.bids || {};
                
                // Aggiorna UI Tasti Asta
                document.getElementById('start-btn').style.display = auctionActive ? "none" : "block";
                document.getElementById('stop-btn').style.display = auctionActive ? "block" : "none";
                
                renderMarket();
            });
        }

        // --- LOGICA MERCATO ---
        function renderMarket() {
            const container = document.getElementById('market-players');
            container.innerHTML = "";

            players.forEach(p => {
                const bid = currentBids[p.id];
                const bidHtml = bid ? `<div class="bid-info">Attuale: ${bid.amount} cr. (${bid.user})</div>` : `<div class="bid-info">Nessuna offerta</div>`;
                
                container.innerHTML += `
                    <div class="player-card">
                        <div><b>${p.name}</b> <small>${p.team}</small>${bidHtml}</div>
                        <div class="bid-controls">
                            <input type="number" id="input-${p.id}" class="bid-input" value="${bid ? bid.amount + 1 : 1}">
                            <button onclick="placeBid(${p.id})" style="background:#22c55e; color:white; border:none; border-radius:5px; cursor:pointer" ${!auctionActive ? 'disabled' : ''}>OFFRI</button>
                        </div>
                    </div>`;
            });
        }

        function toggleAuction(status) {
            db.ref('leagues/' + currentLeague).update({ auctionActive: status });
        }

        function placeBid(playerId) {
            const amount = parseInt(document.getElementById(`input-${playerId}`).value);
            const currentMax = currentBids[playerId] ? currentBids[playerId].amount : 0;

            if (amount <= currentMax) return alert("Offerta troppo bassa!");
            if (amount > budget) return alert("Crediti insufficienti!");

            db.ref('leagues/' + currentLeague + '/bids/' + playerId).set({
                amount: amount,
                user: userName
            });
        }

        function closeAuction() {
            // Assegna i giocatori in base alle offerte finali
            for (let id in currentBids) {
                const bid = currentBids[id];
                if (bid.user === userName) {
                    const player = players.find(p => p.id == id);
                    if (player) {
                        myTeam.push(player);
                        budget -= bid.amount;
                    }
                }
                // Rimuovi dai disponibili
                players = players.filter(p => p.id != id);
            }
            
            document.getElementById('budget-display').innerText = budget;
            db.ref('leagues/' + currentLeague).update({ auctionActive: false, bids: null });
            renderMyRosa();
        }

        // --- LOGICA ROSA ---
        function renderMyRosa() {
            const list = document.getElementById('my-rosa-list');
            list.innerHTML = "<h3>I tuoi acquisti:</h3>";
            myTeam.forEach(p => {
                list.innerHTML += `<div class="league-card">${p.name} (${p.role}) <button onclick="addToField('${p.name}', '${p.role}')">SCHIERA</button></div>`;
            });
        }

        function addToField(name, role) {
            // Semplificazione: per ora schiera nel primo slot libero o fisso
            const slotMap = { "TER": "TS", "PO": "PO" }; // Esempio logica
            const slotId = slotMap[role] || "CE";
            
            const slot = document.getElementById(`slot-${slotId}`);
            slot.innerText = name.split(' ').pop();
            slot.classList.add('occupied');
            fieldOccupancy[slotId] = name;
        }

        function removeFromField(slotId) {
            const slot = document.getElementById(`slot-${slotId}`);
            slot.innerText = slotId;
            slot.classList.remove('occupied');
            delete fieldOccupancy[slotId];
        }

        function showSection(id, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(id === 'rosa') renderMyRosa();
        }
    </script>
</body>
</html>
