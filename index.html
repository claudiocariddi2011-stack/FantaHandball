<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FantaHandball</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f172a; color:#e5e7eb; display:flex; flex-direction:column; align-items:center; padding-bottom:60px; }
header { background:#020617; padding:16px; width:100%; text-align:center; font-size:24px; font-weight:bold; }
.screen { display:none; padding:20px; width:100%; max-width:600px; }
.active { display:block; }
.card { background:#1e293b; border-radius:10px; padding:16px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; }
.btn { background:#22c55e; color:#022c22; border:none; padding:6px 12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-left:8px; }
input, select { padding:6px; border-radius:6px; border:none; margin-bottom:8px; }
nav { display:flex; justify-content:space-around; background:#020617; padding:10px 0; width:100%; position:fixed; bottom:0; max-width:600px; z-index:10; }
nav button { background:none; border:none; color:#e5e7eb; font-size:14px; cursor:pointer; }
#closeAstaBtn { margin-top:20px; position:relative; z-index:5; }
</style>
</head>
<body>
<header>FantaHandball</header>

<section id="login" class="screen active">
  <h2>Benvenuto su FantaHandball</h2>
  <input id="usernameInput" placeholder="Inserisci il tuo nome" />
  <input id="leagueInput" placeholder="Nome lega" />
  <button id="loginBtn" class="btn">Entra</button>
</section>

<section id="home" class="screen">
  <h2 id="welcome"></h2>
  <div class="card">
    <input id="leagueName" placeholder="Nome nuova lega" />
    <button id="createLeagueBtn" class="btn">Crea Lega</button>
  </div>
  <h3>Leghe disponibili</h3>
  <div id="leagues"></div>
  <button class="btn" onclick="generateCalendar()">Genera Calendario</button>
</section>

<section id="svincolati" class="screen">
  <h2>Mercato Svincolati</h2>
  <div id="freePlayers"></div>
  <button class="btn" id="closeAstaBtn">Termina Asta</button>
</section>

<section id="rosa" class="screen">
  <h2>Rosa</h2>
  <div id="players"></div>
</section>

<section id="calendario" class="screen">
  <h2>Calendario</h2>
  <div id="matches"></div>
</section>

<section id="profilo" class="screen">
  <h2>Profilo</h2>
  <div class="card" id="profileName">Username:</div>
  <button class="btn" onclick="showScreen('home')">Torna Home</button>
</section>

<nav>
  <button onclick="showScreen('home')">Home</button>
  <button onclick="showScreen('svincolati')">Mercato</button>
  <button onclick="showScreen('rosa')">Rosa</button>
  <button onclick="showScreen('profilo')">Profilo</button>
  <button onclick="showScreen('calendario')">Calendario</button>
</nav>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyCTqPPwpfNElGluzwjv9nsy8EYBzJUXm2M",
  authDomain: "fantahandaball.firebaseapp.com",
  projectId: "fantahandaball",
  storageBucket: "fantahandaball.firebasestorage.app",
  messagingSenderId: "346312156685",
  appId: "1:346312156685:web:13cee4784534ad7f95d744"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ================= STATO =================
let username = '';
let currentLeague = null;
const startingCredits = 100;

// Lista dei giocatori svincolati
const freeAgents = [
  { name: "Cristian Falsaperla", role: "Terzino", team: "New Handball Mascalucia", highestBid:0, highestBidder:'' },
  { name: "Claudio Cariddi", role: "Terzino", team: "Messina", highestBid:0, highestBidder:'' },
  { name: "Roberto Abbate", role: "Centrale", team: "Messina", highestBid:0, highestBidder:'' },
  { name: "Davide Arnoud", role: "Portiere", team: "Messina", highestBid:0, highestBidder:'' }
  // aggiungi tutti gli altri qui
];

// ================= FUNZIONI =================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='svincolati') renderFreeAgents();
  if(id==='rosa') renderUserTeam();
  if(id==='calendario') renderCalendar();
}

// LOGIN
function login() {
  const name = document.getElementById('usernameInput').value.trim();
  const leagueName = document.getElementById('leagueInput').value.trim();
  if(!name || !leagueName) return alert('Inserisci nome e lega');
  username = name;

  const userRef = db.collection('users').doc(username);
  const leagueRef = db.collection('leagues').doc(leagueName);

  userRef.set({ username, league: leagueName, credits: startingCredits }, { merge:true });
  leagueRef.get().then(doc=>{
    if(doc.exists){
      // Aggiungi membro se non presente
      const members = doc.data().members || [];
      if(!members.includes(username)) members.push(username);
      leagueRef.update({ members });
    } else {
      leagueRef.set({ members:[username], calendar:[], createdAt:new Date() });
    }
    currentLeague = leagueName;
    document.getElementById('welcome').innerText = `Ciao ${username}, Lega: ${currentLeague}`;
    document.getElementById('profileName').innerText = `Username: ${username}`;
    showScreen('home');
    renderLeagues();
    renderUserTeam();
  });
}

// CREA LEGA
function createLeague() {
  const name = document.getElementById('leagueName').value.trim();
  if(!name) return alert('Inserisci il nome della lega');
  const leagueRef = db.collection('leagues').doc(name);
  leagueRef.get().then(doc=>{
    if(doc.exists) return alert('Lega già esistente');
    leagueRef.set({ members:[username], calendar:[], createdAt:new Date() });
    db.collection('users').doc(username).update({ league:name });
    currentLeague = name;
    document.getElementById('leagueName').value='';
    renderLeagues();
    alert(`Lega "${name}" creata con successo!`);
  });
}

// RENDER LEAGUES
function renderLeagues() {
  const container = document.getElementById('leagues');
  container.innerHTML = '';
  db.collection('leagues').orderBy('createdAt','desc').get().then(snap=>{
    snap.forEach(doc=>{
      const l = doc.data();
      const div = document.createElement('div');
      div.className='card';
      div.innerText = `${doc.id} – ${l.members.length} membri`;
      div.onclick = ()=>joinLeague(doc.id);
      container.appendChild(div);
    });
  });
}

// JOIN LEAGUE
function joinLeague(name){
  const leagueRef = db.collection('leagues').doc(name);
  leagueRef.get().then(doc=>{
    if(doc.exists){
      const members = doc.data().members || [];
      if(!members.includes(username)) members.push(username);
      leagueRef.update({ members });
      db.collection('users').doc(username).update({ league:name });
      currentLeague = name;
      alert(`Sei entrato nella lega: ${name}`);
      renderLeagues();
      renderUserTeam();
      renderFreeAgents();
    }
  });
}

// RENDER FREE AGENTS
function renderFreeAgents(){
  const container = document.getElementById('freePlayers');
  container.innerHTML = '';
  freeAgents.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerText = `${p.name} – ${p.role} – ${p.team} – Offerta: ${p.highestBid} (${p.highestBidder||'-'})`;
    const input = document.createElement('input'); input.type='number'; input.min='1'; input.placeholder='Offerta';
    const btn = document.createElement('button'); btn.className='btn'; btn.innerText='Fai Offerta';
    btn.onclick = ()=>placeBid(p, parseInt(input.value));
    div.appendChild(input); div.appendChild(btn);
    container.appendChild(div);
  });
}

function placeBid(player, amount){
  if(!currentLeague) return alert('Unisciti prima a una lega');
  db.collection('users').doc(username).get().then(doc=>{
    const user = doc.data();
    if(isNaN(amount) || amount <= player.highestBid) return alert('Offerta troppo bassa');
    if(amount > user.credits) return alert('Non hai abbastanza crediti');
    player.highestBid = amount;
    player.highestBidder = username;
    renderFreeAgents();
  });
}

// CLOSE ASTA
function closeAsta(){
  freeAgents.forEach(p=>{
    if(p.highestBidder){
      db.collection('users').doc(p.highestBidder).get().then(doc=>{
        const data = doc.data();
        const newTeam = data.team || [];
        newTeam.push({ ...p, price:p.highestBid });
        const newCredits = data.credits - p.highestBid;
        db.collection('users').doc(p.highestBidder).update({ team:newTeam, credits:newCredits });
      });
    }
  });
  for(let i=freeAgents.length-1;i>=0;i--){
    if(freeAgents[i].highestBidder) freeAgents.splice(i,1);
  }
  renderUserTeam();
  renderFreeAgents();
}

// RENDER ROSA
function renderUserTeam(){
  const container = document.getElementById('players');
  db.collection('users').doc(username).get().then(doc=>{
    const data = doc.data();
    container.innerHTML = `<p>Crediti disponibili: ${data.credits}</p>`;
    const team = data.team || [];
    team.forEach((p,i)=>{
      const div = document.createElement('div');
      div.className='card';
      div.innerText = `${i+1}. ${p.name} – ${p.role}`;
      container.appendChild(div);
    });
  });
}

// CALENDARIO
function generateCalendar() {
  if(!currentLeague) return alert('Devi essere in una lega');
  const leagueRef = db.collection('leagues').doc(currentLeague);
  leagueRef.get().then(doc=>{
    const league = doc.data();
    const teams = [...league.members];
    if(teams.length < 2) return alert('Servono almeno 2 squadre per il calendario');
    for (let i = teams.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [teams[i], teams[j]] = [teams[j], teams[i]];
    }
    const matches = [];
    for (let i = 0; i < teams.length; i += 2) {
      if(teams[i+1]) matches.push({ home: teams[i], away: teams[i+1] });
      else matches.push({ home: teams[i], away: 'Riposo' });
    }
    leagueRef.update({ calendar: matches });
    renderCalendar();
    showScreen('calendario');
  });
}

function renderCalendar(){
  if(!currentLeague) return;
  const container = document.getElementById('matches');
  db.collection('leagues').doc(currentLeague).get().then(doc=>{
    const league = doc.data();
    if(!league.calendar) return;
    container.innerHTML = '';
    league.calendar.forEach((m, idx)=>{
      const div = document.createElement('div');
      div.className='card';
      div.innerText = `Giornata ${idx+1}: ${m.home} vs ${m.away}`;
      container.appendChild(div);
    });
  });
}

// EVENT LISTENERS
document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('createLeagueBtn').addEventListener('click', createLeague);
document.getElementById('closeAstaBtn').addEventListener('click', closeAsta);
</script>
</body>
</html>


